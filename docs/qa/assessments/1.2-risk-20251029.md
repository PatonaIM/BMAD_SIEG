# Risk Profile: Story 1.2 - Database Schema & Core Data Models

**Date:** 2025-10-29  
**Reviewer:** Quinn (Test Architect)  
**Story:** 1.2.database-schema.md

## Executive Summary

- **Total Risks Identified:** 14
- **Critical Risks (Score 9):** 2
- **High Risks (Score 6):** 3
- **Medium Risks (Score 4):** 5
- **Low Risks (Score 2-3):** 4
- **Overall Risk Score:** 38/100 (High Risk - Requires Mitigation)

**Key Concern:** Database schema foundation is critical infrastructure. Migration errors, connection issues, and data model flaws will cascade to all future stories. Immediate focus on connection pooling, migration testing, and JSONB validation required.

---

## Critical Risks Requiring Immediate Attention

### 1. DATA-001: Irreversible Migration Errors in Production-Like Environment

**Score: 9 (Critical)**  
**Probability:** High (3) - First-time Alembic setup with complex async configuration  
**Impact:** High (3) - Schema corruption could destroy all interview data, require manual recovery

**Description:**  
Alembic autogenerate may miss indexes (especially GIN on JSONB), create incorrect foreign key constraints, or fail to handle async SQLAlchemy properly. Once applied to Supabase, bad migrations are difficult to rollback without data loss.

**Affected Components:**
- `alembic/versions/*` (migration scripts)
- `alembic/env.py` (async engine configuration)
- All database tables

**Mitigation:**
- **Preventive:**
  - Manually review EVERY autogenerated migration before applying
  - Test migrations on local PostgreSQL instance first (not Supabase directly)
  - Verify GIN indexes on JSONB columns are present in migration
  - Create rollback script BEFORE applying upgrade
  - Use `alembic upgrade head --sql > migration.sql` to review raw SQL
- **Detective:**
  - Add integration test: Apply migration â†’ Insert test data â†’ Rollback â†’ Verify clean state
  - Check `pg_indexes` table after migration to confirm all indexes created
- **Corrective:**
  - Document manual index creation commands as fallback
  - Keep Supabase dashboard SQL editor open during first migration

**Testing Requirements:**
- Task 11: Test migration on fresh local PostgreSQL before Supabase
- Task 11: Test rollback MUST succeed without errors
- Integration test: Full migration cycle (upgrade â†’ downgrade â†’ upgrade)

**Residual Risk:** Low - With thorough review and local testing, risk contained  
**Owner:** Dev  
**Timeline:** Before Task 11 (migration application)

---

### 2. OPS-002: Connection Pool Exhaustion Under Concurrent Load

**Score: 9 (Critical)**  
**Probability:** High (3) - Connection pooling misconfiguration is common  
**Impact:** High (3) - Application deadlock, all API endpoints hang, interviews cannot start

**Description:**  
Supabase free tier has connection limits. `pool_size=10` + `max_overflow=20` = 30 connections, but if connections leak or don't close properly, pool exhausts quickly. Async sessions not properly yielded in `get_db()` dependency will cause leaks.

**Affected Components:**
- `app/core/database.py` (`get_db()` dependency)
- All FastAPI endpoints using database
- `AsyncSessionLocal` sessionmaker

**Mitigation:**
- **Preventive:**
  - Use `async with AsyncSessionLocal() as session:` pattern (auto-closes)
  - Set `pool_recycle=3600` (1 hour) to prevent stale connections
  - Add `pool_timeout=30` to fail fast instead of hanging
  - Enable `pool_pre_ping=True` (already in spec) to detect dead connections
- **Detective:**
  - Add health check endpoint monitoring: `engine.pool.size()`, `engine.pool.checkedout()`
  - Integration test: Simulate 50 concurrent database requests
  - Monitor Supabase dashboard for connection count
- **Corrective:**
  - Implement connection pool metrics in `/health` endpoint
  - Add graceful degradation: Return 503 when pool near exhaustion

**Testing Requirements:**
- Task 15: Load test with 50+ concurrent requests
- Task 15: Verify connections released after endpoint completion
- Add stress test: Hold connections open, verify pool overflow works

**Residual Risk:** Medium - Monitoring will catch issues, but production spikes could still exhaust  
**Owner:** Dev  
**Timeline:** Before Task 12 (FastAPI integration)

---

## High Risks (Score 6)

### 3. TECH-003: Async SQLAlchemy with Alembic Configuration Mismatch

**Score: 6 (High)**  
**Probability:** Medium (2) - Async + Alembic is tricky to configure  
**Impact:** High (3) - Migrations fail silently or apply incorrectly

**Description:**  
Alembic `env.py` must use async engine, but default configuration is synchronous. If `run_migrations_online()` uses sync engine, migrations may appear to succeed but not actually apply schema changes.

**Mitigation:**
- Follow asyncpg + Alembic async recipe precisely
- Test migration with `alembic current` to verify version tracking
- Add integration test: Apply migration â†’ Query `alembic_version` table â†’ Verify version matches

**Testing:** Task 10, 11 - Verify `alembic current` shows correct version after upgrade

---

### 4. DATA-004: JSONB Data Corruption from LangChain Memory Serialization

**Score: 6 (High)**  
**Probability:** Medium (2) - Complex nested objects may not serialize correctly  
**Impact:** High (3) - Interview sessions crash on resume, conversation memory lost

**Description:**  
`InterviewSession.conversation_memory` (JSONB) must store LangChain ConversationBufferMemory. If serialization uses `pickle` or doesn't handle Python objects properly, data becomes unreadable.

**Mitigation:**
- Use `json.dumps()` with custom encoder for datetime/UUID objects
- Add integration test: Create session with mock memory â†’ Save â†’ Reload â†’ Verify structure
- Document JSONB schema format in code comments

**Testing:** Task 15 - JSONB serialization/deserialization test

---

### 5. SEC-005: Database Connection String Exposed in Version Control

**Score: 6 (High)**  
**Probability:** Medium (2) - Common mistake in initial setup  
**Impact:** High (3) - Supabase credentials leaked, unauthorized database access

**Description:**  
`DATABASE_URL` contains Supabase password. If accidentally committed to `alembic.ini` or `.env` file, credentials leak to GitHub.

**Mitigation:**
- Verify `.env` in `.gitignore` before Task 1
- Use environment variable in `alembic.ini`: `sqlalchemy.url = ${DATABASE_URL}`
- Add pre-commit hook to scan for connection strings
- Review git history for accidental commits

**Testing:** Manual verification - Check `.gitignore` and git status before commit

---

## Medium Risks (Score 4)

### 6. PERF-006: Missing Indexes on Foreign Keys Cause Slow Joins

**Score: 4 (Medium)**  
**Probability:** Medium (2) - Alembic autogenerate may skip FK indexes  
**Impact:** Medium (2) - Slow queries when loading interview messages by `interview_id`

**Mitigation:**
- Manually verify indexes on all FK columns: `candidate_id`, `interview_id`, `session_id`
- Add EXPLAIN ANALYZE test queries in integration tests

---

### 7. PERF-007: No GIN Index on JSONB Columns Degrades Query Performance

**Score: 4 (Medium)**  
**Probability:** Medium (2) - GIN indexes must be manually added to migrations  
**Impact:** Medium (2) - Querying nested JSONB fields (e.g., skill scores) becomes slow at scale

**Mitigation:**
- Task 10: Manually add GIN indexes if autogenerate misses them:
  \`\`\`sql
  CREATE INDEX idx_session_memory_gin ON interview_sessions USING GIN (conversation_memory);
  CREATE INDEX idx_message_metadata_gin ON interview_messages USING GIN (metadata);
  \`\`\`

---

### 8. DATA-008: Cascading Deletes Could Accidentally Destroy Interview History

**Score: 4 (Medium)**  
**Probability:** Medium (2) - Cascade behavior not fully tested  
**Impact:** Medium (2) - Deleting candidate removes all their interviews permanently

**Mitigation:**
- Consider soft deletes: `candidates.status = 'deleted'` instead of hard delete
- Add integration test: Delete candidate â†’ Verify interviews also deleted (or retained)
- Document cascade behavior in model comments

---

### 9. OPS-009: Supabase Free Tier Limits Exceed During Load Testing

**Score: 4 (Medium)**  
**Probability:** Medium (2) - Free tier has 500MB storage, limited connections  
**Impact:** Medium (2) - Tests fail, cannot validate production behavior

**Mitigation:**
- Use local PostgreSQL for integration tests (not Supabase)
- Document Supabase limitations in README
- Plan upgrade path to paid tier

---

### 10. TECH-010: SQLAlchemy Model Import Cycles Cause Metadata Conflicts

**Score: 4 (Medium)**  
**Probability:** Medium (2) - Common with relationship definitions  
**Impact:** Medium (2) - Alembic autogenerate fails, models don't import

**Mitigation:**
- Import `Base` from single source in all models
- Use string references for relationships: `relationship("Interview")` not `relationship(Interview)`
- Task 9: Test all models import cleanly in `__init__.py`

---

## Low Risks (Score 2-3)

### 11. BUS-011: Resume and Assessment Models Incomplete for Current Story

**Score: 3 (Low)**  
**Probability:** High (3) - Explicitly marked as placeholders  
**Impact:** Low (1) - No functionality depends on them yet

**Mitigation:** Document as known limitation, implement in future stories

---

### 12. OPS-012: Health Check Doesn't Verify Database Write Capability

**Score: 3 (Low)**  
**Probability:** High (3) - Task 13 only checks `SELECT 1`  
**Impact:** Low (1) - Database might be read-only, but health check passes

**Mitigation:** Consider adding write test: Insert â†’ Delete in health check

---

### 13. DATA-013: No Database Backup Strategy Documented

**Score: 2 (Low)**  
**Probability:** Low (1) - Supabase has automatic backups  
**Impact:** Medium (2) - Data loss possible if Supabase fails

**Mitigation:** Document Supabase backup policy, plan manual backup scripts

---

### 14. TECH-014: Unit Tests Don't Cover All Model Edge Cases

**Score: 2 (Low)**  
**Probability:** Low (1) - Task 14 has comprehensive test plan  
**Impact:** Medium (2) - Minor bugs in validation logic

**Mitigation:** Add edge case tests for JSONB null values, UUID validation

---

## Risk Distribution

### By Category
- **Security (SEC):** 1 risk (0 critical, 1 high)
- **Performance (PERF):** 2 risks (0 critical, 2 medium)
- **Data (DATA):** 3 risks (1 critical, 1 high, 1 low)
- **Business (BUS):** 1 risk (0 critical, 1 low)
- **Operational (OPS):** 3 risks (1 critical, 2 medium)
- **Technical (TECH):** 4 risks (0 critical, 1 high, 3 medium/low)

### By Component
- **Database Schema:** 5 risks (1 critical)
- **Connection Management:** 3 risks (1 critical)
- **SQLAlchemy Models:** 3 risks
- **Alembic Migrations:** 2 risks (1 critical)
- **Testing Infrastructure:** 1 risk

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Pass Before Deployment)

**For DATA-001 (Migration Errors):**
1. **Local Migration Test:**
   - Spin up local PostgreSQL container
   - Apply migration: `alembic upgrade head`
   - Verify tables: `\dt` in psql
   - Check indexes: `SELECT * FROM pg_indexes WHERE tablename IN ('candidates', 'interview_sessions');`
   - Rollback: `alembic downgrade -1`
   - Verify tables dropped
   - Reapply: `alembic upgrade head`

2. **SQL Review Test:**
   - Generate SQL: `alembic upgrade head --sql > migration.sql`
   - Manually review for GIN indexes, foreign keys, CASCADE behavior
   - Compare against schema DDL in `docs/architecture/backend/08-database-schema.md`

**For OPS-002 (Connection Pool Exhaustion):**
1. **Load Test:**
   \`\`\`python
   @pytest.mark.asyncio
   async def test_connection_pool_under_load():
       async def make_request():
           async with AsyncSessionLocal() as session:
               await session.execute("SELECT 1")
       
       tasks = [make_request() for _ in range(50)]
       await asyncio.gather(*tasks)
       
       # Verify pool released connections
       assert engine.pool.checkedout() == 0
   \`\`\`

2. **Connection Leak Test:**
   \`\`\`python
   async def test_no_connection_leaks():
       initial_size = engine.pool.size()
       # Make 100 sequential requests
       for _ in range(100):
           async with AsyncSessionLocal() as session:
               await session.execute("SELECT 1")
       final_size = engine.pool.size()
       assert final_size == initial_size  # No leaks
   \`\`\`

### Priority 2: High Risk Tests

**For TECH-003 (Async Alembic):**
- Test: `alembic current` returns valid version after migration
- Test: Query `alembic_version` table directly via asyncpg

**For DATA-004 (JSONB Serialization):**
\`\`\`python
async def test_jsonb_serialization():
    session_data = {
        "memory": {"history": ["Q1", "A1"], "created_at": datetime.utcnow()},
        "state": {"level": "advanced", "question_count": 5}
    }
    session = InterviewSession(conversation_memory=session_data)
    # Save and reload
    assert session.conversation_memory["memory"]["history"] == ["Q1", "A1"]
\`\`\`

**For SEC-005 (Credential Leak):**
- Manual: `git log --all --full-history --source -- '*alembic.ini' '*\.env'`
- Pre-commit hook: `grep -r "postgresql+asyncpg://" .` (should only match .env.example)

### Priority 3: Medium/Low Risk Tests

- Standard CRUD tests for all models (Task 14)
- Relationship tests (cascade deletes, one-to-many)
- Index verification queries
- Health check endpoint tests

---

## Risk Acceptance Criteria

### Must Fix Before Production
1. âœ… **DATA-001:** Migration tested on local PostgreSQL, manually reviewed
2. âœ… **OPS-002:** Connection pool load test passes (50+ concurrent requests)
3. âœ… **SEC-005:** No credentials in git history, `.env` in `.gitignore`

### Can Deploy with Mitigation
- **TECH-003:** Alembic async config verified via `alembic current` test
- **DATA-004:** JSONB serialization integration test passes
- **PERF-006/007:** Indexes manually verified in Supabase dashboard

### Accepted Risks
- **BUS-011:** Resume/Assessment models incomplete (future stories)
- **OPS-012:** Health check read-only limitation (acceptable for MVP)
- **DATA-013:** Rely on Supabase automatic backups (document limitation)

---

## Monitoring Requirements

Post-deployment monitoring for:

### Database Health
- Connection pool metrics: `pool.size()`, `pool.checkedout()`, `pool.overflow()`
- Query performance: Slow query log (queries >1s)
- Error rates: Connection timeouts, pool exhaustion errors

### Operational Metrics
- Migration success/failure alerts
- Database connection failures
- Supabase storage usage (free tier: 500MB limit)

### Alert Thresholds
- ðŸ”´ **Critical:** Connection pool >80% utilized for >5 minutes
- ðŸŸ  **Warning:** Any migration failure
- ðŸŸ¡ **Info:** Database query >1s response time

---

## Risk Review Triggers

Review and update this risk profile when:
- âœ… Migration applied to Supabase for first time
- âœ… Connection pool exhaustion occurs in any environment
- âœ… JSONB query performance degrades (queries >2s)
- New models added (Stories 1.3+)
- Database schema changes significantly
- Supabase tier upgraded (free â†’ paid)

---

## Recommendations Summary

### Must Fix (Before Story Completion)
1. Test all migrations on local PostgreSQL before applying to Supabase
2. Load test connection pooling with 50+ concurrent requests
3. Manually review autogenerated migrations for missing GIN indexes
4. Verify `.env` in `.gitignore` and no credentials in git history

### Should Monitor (Post-Deployment)
1. Connection pool utilization metrics
2. JSONB query performance via EXPLAIN ANALYZE
3. Supabase storage usage approaching free tier limits

### Nice to Have (Future Stories)
1. Implement soft deletes for candidates instead of CASCADE
2. Add write capability test to health check
3. Document manual backup/restore procedures
4. Implement pre-commit hooks for credential scanning

---

**Risk Score Calculation:**
\`\`\`
Base: 100
- Critical (2 Ã— 20): -40
- High (3 Ã— 10): -30
- Medium (5 Ã— 5): -25
- Low (4 Ã— 2): -8
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Final Score: 38/100 (High Risk)
\`\`\`

**Conclusion:** This story has **elevated risk** due to critical database foundation work. The two critical risks (migration errors and connection pool exhaustion) MUST be mitigated through thorough testing before considering this story complete. With proper local testing and load validation, risk can be reduced to acceptable levels.
