# Test Design: Story 1.2 - Database Schema & Core Data Models

**Date:** 2025-10-29  
**Designer:** Quinn (Test Architect)  
**Story:** 1.2.database-schema.md  
**Story Title:** Database Schema & Core Data Models

## Test Strategy Overview

- **Total test scenarios:** 47
- **Unit tests:** 15 (32%)
- **Integration tests:** 30 (64%)
- **E2E tests:** 2 (4%)
- **Priority distribution:** P0: 23, P1: 18, P2: 6

### Rationale for Distribution

This story is primarily infrastructure and data layer implementation, which naturally skews toward integration testing. The heavy integration test weighting reflects:

1. Database operations require real DB interaction (not mockable)
2. SQLAlchemy ORM behavior must be validated with actual PostgreSQL
3. Migration operations must be tested against real schema
4. Connection pooling requires concurrent request simulation

Unit tests focus on model instantiation, validation logic, and pure functions. Minimal E2E tests validate only the public API surface (health endpoint).

---

## Test Scenarios by Acceptance Criteria

### AC1: Supabase PostgreSQL instance provisioned and connection configured

| ID           | Level       | Priority | Test Scenario                                      | Justification                                          |
| ------------ | ----------- | -------- | -------------------------------------------------- | ------------------------------------------------------ |
| 1.2-INT-001  | Integration | P0       | Verify database connection string format is valid  | Critical: invalid format blocks all DB operations      |
| 1.2-INT-002  | Integration | P0       | Establish connection to Supabase PostgreSQL        | Critical: confirms infrastructure provisioning success |
| 1.2-INT-003  | Integration | P1       | Verify connection uses asyncpg driver              | Ensures correct async driver for FastAPI               |
| 1.2-E2E-001  | E2E         | P0       | Health endpoint returns database connection status | Critical user-facing validation of DB availability     |
| 1.2-INT-004  | Integration | P1       | Verify connection handles network timeout          | Error handling for infrastructure issues               |

**Coverage Summary:** 5 tests (1 E2E, 4 Integration)

---

### AC2: Database migration tool (Alembic) initialized with version control

| ID           | Level       | Priority | Test Scenario                                          | Justification                                 |
| ------------ | ----------- | -------- | ------------------------------------------------------ | --------------------------------------------- |
| 1.2-INT-005  | Integration | P0       | Alembic creates migration version table                | Core migration functionality                  |
| 1.2-INT-006  | Integration | P0       | Alembic can generate autogenerated migration           | Critical for schema version control           |
| 1.2-INT-007  | Integration | P0       | Alembic env.py loads Base.metadata correctly           | Required for autogenerate to detect models    |
| 1.2-INT-008  | Integration | P1       | Alembic migration includes all model changes           | Comprehensive schema evolution                |
| 1.2-INT-009  | Integration | P1       | Alembic revision command creates timestamped migration | Version control integrity                     |
| 1.2-UNIT-001 | Unit        | P2       | Verify alembic.ini contains valid database URL format  | Configuration validation without DB call      |

**Coverage Summary:** 6 tests (1 Unit, 5 Integration)

---

### AC3: Core tables created (candidates, interviews, interview_messages, interview_sessions)

| ID           | Level       | Priority | Test Scenario                                   | Justification                            |
| ------------ | ----------- | -------- | ----------------------------------------------- | ---------------------------------------- |
| 1.2-INT-010  | Integration | P0       | Migration creates candidates table              | Core entity for system                   |
| 1.2-INT-011  | Integration | P0       | Migration creates interviews table              | Core entity for system                   |
| 1.2-INT-012  | Integration | P0       | Migration creates interview_sessions table      | Core entity for system                   |
| 1.2-INT-013  | Integration | P0       | Migration creates interview_messages table      | Core entity for system                   |
| 1.2-INT-014  | Integration | P1       | Migration creates resumes table (placeholder)   | Future-proofing for later stories        |
| 1.2-INT-015  | Integration | P1       | Migration creates assessment_results table      | Future-proofing for later stories        |
| 1.2-INT-016  | Integration | P0       | All tables have correct primary key (UUID)      | Data integrity requirement               |
| 1.2-INT-017  | Integration | P0       | All foreign keys are properly created           | Referential integrity requirement        |

**Coverage Summary:** 8 tests (8 Integration)

---

### AC4: JSONB columns included for flexible AI-generated data storage

| ID           | Level       | Priority | Test Scenario                                         | Justification                                 |
| ------------ | ----------- | -------- | ----------------------------------------------------- | --------------------------------------------- |
| 1.2-INT-018  | Integration | P0       | InterviewSession.conversation_memory is JSONB         | Critical for LangChain state persistence      |
| 1.2-INT-019  | Integration | P0       | InterviewSession JSONB columns have GIN indexes       | Query performance requirement                 |
| 1.2-INT-020  | Integration | P0       | JSONB columns can store and retrieve complex objects  | Functional validation of JSONB                |
| 1.2-INT-021  | Integration | P1       | JSONB columns accept null values when nullable=True   | Schema flexibility requirement                |
| 1.2-UNIT-002 | Unit        | P1       | JSONB data serialization/deserialization logic        | Data transformation correctness               |
| 1.2-INT-022  | Integration | P1       | JSONB fields support nested object queries            | Advanced query capability validation          |

**Coverage Summary:** 6 tests (1 Unit, 5 Integration)

---

### AC5: Database models defined in backend with SQLAlchemy ORM

| ID           | Level       | Priority | Test Scenario                                            | Justification                                         |
| ------------ | ----------- | -------- | -------------------------------------------------------- | ----------------------------------------------------- |
| 1.2-UNIT-003 | Unit        | P0       | Candidate model instantiation with valid data            | Core model validation                                 |
| 1.2-UNIT-004 | Unit        | P0       | Interview model instantiation with required fields       | Core model validation                                 |
| 1.2-UNIT-005 | Unit        | P0       | InterviewSession model instantiation                     | Core model validation                                 |
| 1.2-UNIT-006 | Unit        | P0       | InterviewMessage model instantiation                     | Core model validation                                 |
| 1.2-UNIT-007 | Unit        | P1       | Resume model instantiation (placeholder)                 | Placeholder model validation                          |
| 1.2-UNIT-008 | Unit        | P1       | AssessmentResult model instantiation (placeholder)       | Placeholder model validation                          |
| 1.2-UNIT-009 | Unit        | P0       | Candidate model validates email format                   | Data validation logic                                 |
| 1.2-UNIT-010 | Unit        | P1       | Models have correct default values (created_at, etc.)    | Default behavior validation                           |
| 1.2-UNIT-011 | Unit        | P1       | Candidate.__repr__() returns formatted string            | Debugging support validation                          |
| 1.2-INT-023  | Integration | P0       | Candidate model persists to database correctly           | ORM persistence validation                            |
| 1.2-INT-024  | Integration | P0       | Interview model persists with foreign key relationships  | Relationship persistence validation                   |
| 1.2-INT-025  | Integration | P0       | InterviewSession one-to-one relationship with Interview  | Complex relationship validation                       |
| 1.2-INT-026  | Integration | P0       | InterviewMessage many-to-one relationships work          | Multiple relationship validation                      |
| 1.2-INT-027  | Integration | P1       | Candidate email uniqueness constraint enforced           | Database-level constraint validation                  |
| 1.2-INT-028  | Integration | P1       | Cascade delete works (delete Candidate deletes data)     | Referential integrity behavior                        |

**Coverage Summary:** 15 tests (9 Unit, 6 Integration)

---

### AC6: Proper indexes created for query performance

| ID           | Level       | Priority | Test Scenario                                               | Justification                                    |
| ------------ | ----------- | -------- | ----------------------------------------------------------- | ------------------------------------------------ |
| 1.2-INT-029  | Integration | P0       | Index exists on candidates.email                            | Critical query performance (login lookup)        |
| 1.2-INT-030  | Integration | P0       | Index exists on interviews.candidate_id                     | Foreign key query performance                    |
| 1.2-INT-031  | Integration | P0       | Composite index on (interview_id, sequence_number)          | Message chronological retrieval optimization     |
| 1.2-INT-032  | Integration | P1       | Index exists on interviews.status                           | Status-based filtering performance               |
| 1.2-INT-033  | Integration | P1       | Index exists on interviews.created_at                       | Temporal queries performance                     |
| 1.2-INT-034  | Integration | P1       | GIN index exists on JSONB columns                           | JSONB query performance                          |
| 1.2-INT-035  | Integration | P2       | Verify index usage with EXPLAIN ANALYZE on common queries   | Index effectiveness validation                   |

**Coverage Summary:** 7 tests (7 Integration)

---

### AC7: Database connection pooling configured for concurrent session support

| ID           | Level       | Priority | Test Scenario                                         | Justification                                      |
| ------------ | ----------- | -------- | ----------------------------------------------------- | -------------------------------------------------- |
| 1.2-UNIT-012 | Unit        | P1       | Database engine has pool_size=10 configured           | Configuration validation without connection        |
| 1.2-UNIT-013 | Unit        | P1       | Database engine has max_overflow=20 configured        | Configuration validation without connection        |
| 1.2-UNIT-014 | Unit        | P1       | Database engine has pool_pre_ping=True configured     | Configuration validation without connection        |
| 1.2-INT-036  | Integration | P0       | Connection pool handles 10 concurrent requests        | Base capacity validation                           |
| 1.2-INT-037  | Integration | P0       | Connection pool handles 30 concurrent requests (overflow) | Burst capacity validation                      |
| 1.2-INT-038  | Integration | P1       | Connection pool recovers from disconnected connection | Resilience with pool_pre_ping                      |
| 1.2-INT-039  | Integration | P2       | Connection pool properly closes on app shutdown       | Resource cleanup validation                        |
| 1.2-E2E-002  | E2E         | P1       | FastAPI startup completes without DB connection error | End-to-end lifecycle validation                    |

**Coverage Summary:** 8 tests (3 Unit, 4 Integration, 1 E2E)

---

### AC8: Migration scripts tested (can initialize fresh database and rollback changes)

| ID           | Level       | Priority | Test Scenario                                    | Justification                              |
| ------------ | ----------- | -------- | ------------------------------------------------ | ------------------------------------------ |
| 1.2-INT-040  | Integration | P0       | Alembic upgrade head creates all tables          | Forward migration validation               |
| 1.2-INT-041  | Integration | P0       | Alembic downgrade -1 removes tables              | Rollback capability validation             |
| 1.2-INT-042  | Integration | P0       | Alembic upgrade after downgrade restores schema  | Migration repeatability validation         |
| 1.2-INT-043  | Integration | P1       | Migration can be applied to fresh database       | Clean install scenario                     |
| 1.2-INT-044  | Integration | P1       | Alembic history shows correct migration sequence | Version control audit trail                |
| 1.2-INT-045  | Integration | P2       | Migration idempotency (running twice is safe)    | Operational safety validation              |
| 1.2-UNIT-015 | Unit        | P2       | Migration file contains upgrade and downgrade    | Code structure validation                  |

**Coverage Summary:** 7 tests (1 Unit, 6 Integration)

---

## Additional Cross-Cutting Test Scenarios

These tests validate interactions across multiple acceptance criteria:

| ID           | Level       | Priority | Test Scenario                                             | ACs Covered | Justification                      |
| ------------ | ----------- | -------- | --------------------------------------------------------- | ----------- | ---------------------------------- |
| 1.2-INT-046  | Integration | P0       | Complete interview workflow (create all related entities) | 3, 5        | Integration smoke test             |
| 1.2-INT-047  | Integration | P1       | Query interview messages in chronological order           | 5, 6        | Real-world usage pattern           |

**Coverage Summary:** 2 tests (2 Integration)

---

## Test Scenarios Summary by Level

### Unit Tests (15 total)

**Focus:** Model instantiation, configuration validation, pure logic

1. 1.2-UNIT-001: Alembic config validation
2. 1.2-UNIT-002: JSONB serialization logic
3. 1.2-UNIT-003: Candidate model instantiation
4. 1.2-UNIT-004: Interview model instantiation
5. 1.2-UNIT-005: InterviewSession model instantiation
6. 1.2-UNIT-006: InterviewMessage model instantiation
7. 1.2-UNIT-007: Resume model instantiation
8. 1.2-UNIT-008: AssessmentResult model instantiation
9. 1.2-UNIT-009: Email validation logic
10. 1.2-UNIT-010: Default values validation
11. 1.2-UNIT-011: __repr__() method validation
12. 1.2-UNIT-012: pool_size configuration
13. 1.2-UNIT-013: max_overflow configuration
14. 1.2-UNIT-014: pool_pre_ping configuration
15. 1.2-UNIT-015: Migration file structure

### Integration Tests (30 total)

**Focus:** Database operations, migrations, ORM persistence, relationships

1. 1.2-INT-001 through 1.2-INT-045: See detailed listings above
2. 1.2-INT-046: Complete workflow integration test
3. 1.2-INT-047: Query chronological messages

### E2E Tests (2 total)

**Focus:** User-facing API validation

1. 1.2-E2E-001: Health endpoint with DB status
2. 1.2-E2E-002: FastAPI startup with DB connection

---

## Risk Coverage

### Data Integrity Risks

**Risk:** Cascade deletes could remove unintended data  
**Tests:** 1.2-INT-028 (validates cascade behavior)

**Risk:** JSONB columns could accept invalid data structures  
**Tests:** 1.2-INT-020, 1.2-INT-021, 1.2-UNIT-002

**Risk:** Migration rollback could corrupt data  
**Tests:** 1.2-INT-041, 1.2-INT-042, 1.2-INT-043

### Performance Risks

**Risk:** Missing indexes cause slow queries  
**Tests:** 1.2-INT-029 through 1.2-INT-035

**Risk:** Connection pool exhaustion under load  
**Tests:** 1.2-INT-036, 1.2-INT-037

### Operational Risks

**Risk:** Invalid Supabase connection string blocks deployment  
**Tests:** 1.2-INT-001, 1.2-INT-002

**Risk:** Migration cannot be applied to production  
**Tests:** 1.2-INT-043, 1.2-INT-045

---

## Recommended Execution Order

### Phase 1: Critical Path (P0 Tests)

Execute in this order for fastest feedback on blockers:

1. **Unit tests (P0):** 1.2-UNIT-003 through 1.2-UNIT-009 (model validation)
2. **Integration - Connection:** 1.2-INT-001, 1.2-INT-002 (DB connectivity)
3. **Integration - Migration:** 1.2-INT-005, 1.2-INT-006, 1.2-INT-007 (Alembic setup)
4. **Integration - Tables:** 1.2-INT-010 through 1.2-INT-017 (schema creation)
5. **Integration - JSONB:** 1.2-INT-018, 1.2-INT-019, 1.2-INT-020 (AI data storage)
6. **Integration - ORM:** 1.2-INT-023 through 1.2-INT-026 (model persistence)
7. **Integration - Indexes:** 1.2-INT-029, 1.2-INT-030, 1.2-INT-031 (query performance)
8. **Integration - Pooling:** 1.2-INT-036, 1.2-INT-037 (concurrency)
9. **Integration - Migrations:** 1.2-INT-040, 1.2-INT-041, 1.2-INT-042 (rollback)
10. **E2E - Health:** 1.2-E2E-001 (public API validation)
11. **Integration - Smoke:** 1.2-INT-046 (end-to-end workflow)

### Phase 2: Important Validation (P1 Tests)

Execute after P0 tests pass:

- All P1 unit tests (configuration validation)
- All P1 integration tests (secondary indexes, error handling)
- 1.2-E2E-002 (startup lifecycle)

### Phase 3: Additional Coverage (P2 Tests)

Execute if time permits or in full regression:

- All P2 tests (EXPLAIN ANALYZE, idempotency, cleanup)

---

## Test Implementation Notes

### Test Database Setup

Use separate test database to avoid dev data pollution:

```python
# tests/conftest.py
@pytest.fixture(scope="session")
async def test_engine():
    engine = create_async_engine(
        "postgresql+asyncpg://test:test@localhost:5432/test_db",
        pool_size=5,
        max_overflow=10
    )
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    yield engine
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)
    await engine.dispose()
```

### Mock Strategy

- **DO NOT mock:** Database connections in integration tests
- **DO mock:** External APIs (none in this story)
- **DO mock:** Time-dependent defaults in unit tests (use freezegun)

### Concurrency Testing

For connection pool tests (1.2-INT-036, 1.2-INT-037):

```python
import asyncio

async def test_concurrent_connections():
    tasks = [create_candidate() for _ in range(30)]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    assert all(isinstance(r, Candidate) for r in results)
```

---

## Coverage Gaps

**None identified.** All acceptance criteria have comprehensive test coverage.

---

## Test Maintenance Considerations

### High Maintenance Risk

- **Migration tests (INT-040 through INT-045):** Will need updates as schema evolves
- **Index tests (INT-029 through INT-035):** Require database inspection queries

### Low Maintenance Risk

- **Unit tests (UNIT-003 through UNIT-011):** Pure model validation, stable
- **ORM tests (INT-023 through INT-028):** Core SQLAlchemy patterns, stable

### Recommendations

1. Use database fixtures with automatic cleanup to avoid test pollution
2. Tag migration tests separately for isolation (`@pytest.mark.migration`)
3. Create helper functions for common patterns (create_test_candidate, etc.)
4. Monitor test execution time; add `@pytest.mark.slow` for >1s tests

---

## Quality Gate Input

```yaml
test_design:
  scenarios_total: 47
  by_level:
    unit: 15
    integration: 30
    e2e: 2
  by_priority:
    p0: 23
    p1: 18
    p2: 6
  coverage_gaps: []
  risk_coverage:
    data_integrity: 4
    performance: 9
    operational: 4
  estimated_execution_time:
    unit_tests: "5 seconds"
    integration_tests: "60-90 seconds"
    e2e_tests: "10 seconds"
    total: "~2 minutes"
```

---

## Conclusion

This test strategy provides comprehensive coverage for Story 1.2 with appropriate test level distribution. The heavy emphasis on integration testing reflects the infrastructure nature of database schema implementation, where real database interaction is essential for validation.

**Key strengths:**

- Every AC has multiple test scenarios
- P0 tests create fast feedback loop
- No duplicate coverage across levels
- Risk-based priority assignment
- Practical execution order defined

**Next steps:**

1. Implement P0 tests first during development
2. Run trace-requirements task to map tests to Given-When-Then format
3. Create quality gate using test design metrics
4. Execute tests in recommended order
