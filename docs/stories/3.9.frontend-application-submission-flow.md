# Story 3.9: Frontend Application Submission Flow

## Status
Draft

## Story Context

**Existing System Integration:**
- Depends on: Story 3.5 (Application REST API Endpoints - COMPLETED ✅), Story 3.7 (Frontend Job Browsing Page Update - COMPLETED ✅), Story 3.8 (Frontend Dashboard & Applications Page Update - COMPLETED ✅)
- Integrates with: Existing `/jobs/page.tsx` job list, Job detail page pattern (links to `/jobs/[id]`), React Query mutation patterns
- Technology: Next.js 14, TypeScript, React 18, TanStack Query (useMutation), shadcn/ui, Tailwind CSS, Zustand (auth store)
- Follows pattern: Existing API integration pattern from Story 3.7/3.8, mutation patterns for POST requests
- Touch points: Job detail page (needs creation), Job list cards "Apply" button, API client mutations, application state management

## Story

**As an** authenticated candidate,  
**I want** to apply to a job posting with one click,  
**so that** I can quickly submit my application and start the interview process.

## Acceptance Criteria

**Functional Requirements:**

1. Job detail page created at `/jobs/[id]/page.tsx` displaying full job posting details
2. "Apply Now" button displayed on job detail page for authenticated users
3. "Sign in to apply" button displayed for unauthenticated users (redirects to `/login`)
4. Custom hook `useApplyToJob` created using useMutation for application submission
5. Button click calls `POST /api/v1/applications` with `job_posting_id` in request body
6. Loading state displays during application submission (button shows spinner, disabled)
7. Success state shows confirmation message and updates button to "Applied" (disabled)
8. Success message includes "Start Interview Now" button/link
9. Error handling for duplicate applications shows "Already applied to this job" message
10. Error handling for other failures shows generic error with retry button
11. Button state persists: if already applied, button shows "Applied" and is disabled
12. Application submission triggers cache invalidation for applications list (React Query)

**UI/UX Requirements:**

13. Job detail page layout matches existing design system (shadcn/ui Card components)
14. Job detail page displays: title, company, description, requirements, skills, salary, location, employment type, work setup, experience level, benefits
15. Loading skeleton shown while job detail fetches from API
16. Error state on job detail page if job not found or API fails
17. Success toast notification appears on successful application
18. Button transitions smooth (no jarring state changes)

**Quality Requirements:**

19. Code follows Next.js 14 App Router patterns (dynamic routes with [id] folder)
20. TypeScript strict mode compliance (no `any` types, proper type definitions)
21. Authentication check uses existing `useAuthStore` pattern from Story 3.8
22. React Query mutation follows best practices (onSuccess, onError, invalidateQueries)
23. Component follows existing pattern from Story 3.7/3.8 for API integration

## Tasks / Subtasks

- [x] **Task 0: Verify Job Detail API Endpoint Available** (AC: 1, 16)
  - [x] Verify Story 3.4 completed: `GET /api/v1/job-postings/{id}` endpoint exists
  - [x] Test endpoint manually with valid job ID
  - [x] Test endpoint with invalid ID (verify 404 handling)
  - [x] Verify response schema matches TypeScript interface `JobPosting`
  - [x] Source: [backend/app/api/v1/job_postings.py (from Story 3.4)]

- [x] **Task 1: Add Application API Functions to API Client** (AC: 5, 20)
  - [x] Open `frontend/lib/api-client.ts`
  - [x] Add function `getJobPostingById(id: string): Promise<JobPosting>`
    - Fetch from `GET /api/v1/job-postings/${id}`
    - Return JobPosting interface
    - Throw error if not found
  - [x] Add function `createApplication(jobPostingId: string): Promise<ApplicationWithJobDetails>`
    - POST to `/api/v1/applications`
    - Request body: `{ job_posting_id: jobPostingId }`
    - Include JWT token from localStorage in Authorization header: `Bearer ${token}`
    - Return ApplicationWithJobDetails interface
    - Throw appropriate error for 409 Conflict (already applied)
    - Throw generic error for other failures
  - [x] Add JSDoc comments explaining each function
  - [x] Source: [frontend/lib/api-client.ts (existing file), Story 3.7/3.8 pattern]

- [x] **Task 2: Create useJobPosting Hook for Job Detail Fetching** (AC: 1, 15, 16, 23)
  - [x] Create file `frontend/hooks/use-job-posting.ts`
  - [x] Import React Query: `import { useQuery } from '@tanstack/react-query'`
  - [x] Import API client: `import { getJobPostingById } from '@/lib/api-client'`
  - [x] Create hook `useJobPosting(id: string)`:
    - Query key: `['job-postings', id]`
    - Query function: `() => getJobPostingById(id)`
    - Configure: staleTime=5min, retry=2
    - Return: `{ data, isLoading, isError, error }`
  - [x] Add JSDoc comment explaining hook usage
  - [x] Source: [frontend/hooks/use-job-postings.ts (Story 3.7 pattern), frontend/hooks/use-applications.ts (Story 3.8 pattern)]

- [x] **Task 3: Create useApplyToJob Hook for Application Submission** (AC: 4, 5, 6, 7, 8, 9, 10, 12, 22)
  - [x] Create file `frontend/hooks/use-apply-to-job.ts`
  - [x] Import React Query: `import { useMutation, useQueryClient } from '@tanstack/react-query'`
  - [x] Import API client: `import { createApplication } from '@/lib/api-client'`
  - [x] Import toast (for success notification): `import { toast } from '@/components/ui/use-toast'`
  - [x] Create hook `useApplyToJob()`:
    - Use `useMutation` with mutation function: `(jobPostingId: string) => createApplication(jobPostingId)`
    - Configure `onSuccess`:
      - Show success toast: "Application submitted successfully!"
      - Invalidate queries: `['applications', 'me']` (refresh applications list)
      - Call optional onSuccess callback passed to hook
    - Configure `onError`:
      - Check if error is 409 Conflict: show "Already applied" message
      - Otherwise show generic error message
      - Call optional onError callback passed to hook
    - Return: `{ mutate, isPending, isSuccess, isError, error, data }`
  - [x] Add JSDoc comment explaining hook usage
  - [x] Source: [React Query mutation docs, Story 3.7/3.8 patterns]

- [x] **Task 4: Create Job Detail Page** (AC: 1, 2, 3, 11, 13, 14, 15, 16, 19, 21, 23)
  - [x] Create folder `frontend/app/jobs/[id]/`
  - [x] Create file `frontend/app/jobs/[id]/page.tsx`
  - [x] Add `"use client"` directive at top (required for hooks)
  - [x] Import necessary components: Card, CardHeader, CardTitle, CardDescription, CardContent, Button, Badge, Skeleton
  - [x] Import hooks: useParams (Next.js), useRouter, useAuthStore, useJobPosting, useApplyToJob
  - [x] Import icons: MapPin, DollarSign, Briefcase, Clock, Building2, CheckCircle2, ArrowLeft
  - [x] Import Link from Next.js
  - [x] Get job ID from route params: `const params = useParams(); const jobId = params.id as string;`
  - [x] Check authentication: `const isAuthenticated = useAuthStore((state) => state.isAuthenticated())`
  - [x] Fetch job details: `const { data: job, isLoading, isError, error } = useJobPosting(jobId)`
  - [x] Setup application mutation: `const { mutate: applyToJob, isPending, isSuccess, isError: applyError } = useApplyToJob()`
  - [x] Check if already applied: Query applications list and check if job_posting_id matches current job
    - Import useApplications: `import { useApplications } from '@/hooks/use-applications'`
    - Check: `const { data: applications } = useApplications()`
    - Calculate: `const alreadyApplied = applications?.some(app => app.job_posting_id === jobId)`
  - [x] Implement loading state: Show skeleton loaders for job details
  - [x] Implement error state: Show error message with back button
  - [x] Implement main content layout:
    - Back button to /jobs
    - Job header: title, company, status badge
    - Job details grid: location, salary, employment type, work setup, experience level
    - Description section
    - Requirements section (required_skills as badges)
    - Preferred skills section (preferred_skills as badges)
    - Benefits section (benefits list)
    - Apply button at bottom (sticky or fixed)
  - [x] Implement Apply button logic:
    - If not authenticated: Show "Sign in to apply" button, onClick redirects to /login
    - If already applied OR isSuccess: Show "Applied" button (disabled, success color)
    - If isPending: Show "Applying..." button with spinner (disabled)
    - Otherwise: Show "Apply Now" button, onClick calls `applyToJob(jobId)`
  - [x] Source: [frontend/app/jobs/page.tsx (Story 3.7), frontend/app/applications/page.tsx (Story 3.8), Next.js dynamic routes docs]

- [x] **Task 5: Add Success State with Interview Link** (AC: 8)
  - [x] In job detail page, after successful application:
    - Display success message card/alert: "Application submitted successfully!"
    - Include button/link: "Start Interview Now"
    - Link navigates to: `/interview/start?application_id=${applicationData.id}`
    - Use data from mutation response: `const { data: applicationData } = useApplyToJob()`
  - [x] Alternative: Show modal/dialog with success message and interview link
  - [x] Source: [shadcn/ui Alert component, shadcn/ui Dialog component]

- [ ] **Task 6: Add Apply Button to Job List Cards (Optional Enhancement)** (AC: 2, 3, 11)
  - [ ] Open `frontend/app/jobs/page.tsx`
  - [ ] Import useAuthStore, useApplications, useApplyToJob hooks
  - [ ] For each job card, check if already applied (similar to Task 4)
  - [ ] Add "Apply" button next to "View Details" button:
    - If not authenticated: disabled or hidden
    - If already applied: Show "Applied" (disabled)
    - Otherwise: Show "Apply" button, onClick calls `applyToJob(job.id)`
  - [ ] Show toast notification on success (handled by useApplyToJob hook)
  - [ ] **IMPORTANT:** This task is optional enhancement, not required for AC
  - [ ] Source: [frontend/app/jobs/page.tsx (existing file)]

- [x] **Task 7: Add Toast Notification Component** (AC: 17)
  - [x] Check if `frontend/components/ui/use-toast.ts` and `frontend/components/ui/toast.tsx` exist
  - [x] If missing, install shadcn/ui toast component: `cd frontend && npx shadcn-ui@latest add toast`
  - [x] Verify Toaster component added to root layout: `frontend/app/layout.tsx`
  - [x] If not present, add `<Toaster />` component to layout
  - [x] Test toast notifications work
  - [x] Source: [shadcn/ui Toast documentation]

- [ ] **Task 8: Handle Edge Cases** (AC: 9, 10, 11)
  - [ ] Test duplicate application scenario:
    - Apply to job → success
    - Refresh page → verify "Applied" button shows (not "Apply Now")
    - Try applying again → verify error message shows
  - [ ] Test unauthenticated scenario:
    - Logout
    - Navigate to job detail
    - Verify "Sign in to apply" button shows
    - Click button → verify redirects to /login with return URL
  - [ ] Test network failure scenario:
    - Stop backend
    - Try applying → verify error message shows with retry button
    - Restart backend → click retry → verify success
  - [ ] Source: [Testing requirements from Story 3.7/3.8]

- [x] **Task 9: Type Safety and Linting** (AC: 20, 23)
  - [x] Run TypeScript compiler: `cd frontend && pnpm tsc --noEmit`
  - [x] Fix any type errors in new code
  - [x] Run linter: `cd frontend && pnpm lint`
  - [x] Fix any linting warnings
  - [x] Ensure no `any` types used
  - [x] Verify all TypeScript interfaces properly defined
  - [x] Source: [docs/architecture/frontend/11-frontend-developer-standards.md]

- [ ] **Task 10: Manual Testing** (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18)
  - [ ] Start backend server: `cd backend && uvicorn main:app --reload`
  - [ ] Ensure seed data exists: job postings and candidate account
  - [ ] Start frontend dev server: `cd frontend && pnpm dev`
  - [ ] **Test job detail page:**
    - [ ] Navigate to http://localhost:3000/jobs
    - [ ] Click "View Details" on any job card
    - [ ] Verify job detail page loads with all information
    - [ ] Verify skeleton loaders appear during fetch
    - [ ] Verify back button works (returns to /jobs)
  - [ ] **Test unauthenticated flow:**
    - [ ] Logout if logged in
    - [ ] Navigate to job detail page
    - [ ] Verify "Sign in to apply" button shows
    - [ ] Click button → verify redirects to /login
    - [ ] Login → verify redirects back to job detail page
  - [ ] **Test application submission:**
    - [ ] Ensure authenticated
    - [ ] On job detail page, click "Apply Now" button
    - [ ] Verify button shows "Applying..." with spinner
    - [ ] Wait for response
    - [ ] Verify success toast notification appears
    - [ ] Verify button changes to "Applied" (disabled)
    - [ ] Verify "Start Interview Now" link/button appears
  - [ ] **Test already applied state:**
    - [ ] Refresh page or navigate away and back
    - [ ] Verify button still shows "Applied" (disabled)
    - [ ] Navigate to /applications page
    - [ ] Verify new application appears in list
  - [ ] **Test duplicate application prevention:**
    - [ ] Try applying to same job again (should not be possible - button disabled)
    - [ ] Manually call API (via dev tools or curl) → verify 409 error
  - [ ] **Test error handling:**
    - [ ] Stop backend server
    - [ ] Try applying to different job
    - [ ] Verify error message appears
    - [ ] Restart backend
    - [ ] Retry application → verify success
  - [ ] **Test interview link:**
    - [ ] After successful application, click "Start Interview Now"
    - [ ] Verify navigation to `/interview/start?application_id={id}`
    - [ ] Verify interview start page receives application_id (check via console.log or React DevTools)
  - [ ] **Test responsive design:**
    - [ ] Resize browser to mobile width (375px)
    - [ ] Verify job detail layout stacks correctly
    - [ ] Verify Apply button remains accessible
    - [ ] Verify all information readable on mobile
  - [ ] **Test React Query caching:**
    - [ ] Open React Query DevTools (bottom left)
    - [ ] Navigate to job detail → verify query `['job-postings', id]`
    - [ ] Apply to job → verify mutation executes
    - [ ] Verify `['applications', 'me']` query invalidates after success
    - [ ] Navigate to /applications → verify cache hit (instant load)

## Dev Notes

### Previous Story Insights

**From Story 3.5: Application REST API Endpoints (COMPLETED ✅)**

- **API Endpoints Available:**
  - `POST /api/v1/applications` - Create application (authenticated)
    - Request body: `{ job_posting_id: UUID }`
    - Returns: ApplicationWithJobDetails (includes nested job_posting and interview objects)
    - Status codes: 201 Created (success), 409 Conflict (duplicate), 404 Not Found (job doesn't exist)
  - `GET /api/v1/applications/me` - Get candidate's applications (authenticated)
  - `GET /api/v1/applications/{id}` - Get single application detail (authenticated)
- **Authentication Required:** All endpoints require JWT token in `Authorization: Bearer {token}` header
- **Automatic Interview Creation:** POST endpoint automatically creates interview and links to application
- **Response Schema:**
  - ApplicationWithJobDetails includes: { id, job_posting_id, candidate_id, status, applied_at, interview_id, job_posting: {...}, interview: {...} }

**From Story 3.4: Job Posting REST API Endpoints (COMPLETED ✅)**

- **API Endpoints Available:**
  - `GET /api/v1/job-postings` - List with filters and pagination
  - `GET /api/v1/job-postings/{id}` - Single job detail (public, no auth required)
- **Response Schema:**
  - JobPostingResponse includes all fields: id, title, company, description, role_category, tech_stack, employment_type, work_setup, experience_level, location, salary_range_min, salary_range_max, required_skills, preferred_skills, benefits, posted_at, closing_at, status
- **No Authentication Required:** Job browsing is public

**From Story 3.7: Frontend Job Browsing Page Update (COMPLETED ✅)**

- **API Integration Pattern Established:**
  - Custom hooks wrapping React Query (useQuery pattern)
  - API client with fetch wrapper in `frontend/lib/api-client.ts`
  - Type-safe interfaces matching backend schemas
  - Loading/error/success states handled via React Query
  - Skeleton loaders for initial page load
- **File Structure:**
  - API client: `frontend/lib/api-client.ts`
  - Custom hooks: `frontend/hooks/use-*.ts`
  - Pages: `frontend/app/*/page.tsx`
- **JobPosting Interface Already Defined:** Available in api-client.ts

**From Story 3.8: Frontend Dashboard & Applications Page Update (COMPLETED ✅)**

- **Authentication Pattern:**
  - Zustand auth store: `frontend/src/features/auth/store/authStore.ts`
  - Check auth: `const isAuthenticated = useAuthStore((state) => state.isAuthenticated())`
  - Get token: `const token = useAuthStore((state) => state.token)`
  - Token stored in localStorage key: 'auth_token'
  - Protected routes redirect to /login if not authenticated
- **useApplications Hook Available:** Already created in `frontend/hooks/use-applications.ts`
  - Returns: `{ data: ApplicationWithJobDetails[], isLoading, isError, error, refetch }`
  - Query key: `['applications', 'me']`
- **React Query Mutation Pattern:**
  - Use useMutation for POST/PUT/DELETE operations
  - Configure onSuccess for cache invalidation and notifications
  - Configure onError for error handling

### Technical Architecture Context

**Frontend Tech Stack** [Source: docs/architecture/frontend/02-frontend-tech-stack.md]
- **Framework:** Next.js 14 (App Router, React 18, TypeScript 5)
- **State Management:** 
  - React Query (TanStack Query) for server state
  - Zustand for global client state (auth)
  - React hooks for local component state
- **UI Components:** shadcn/ui (Radix UI primitives + Tailwind CSS)
- **Styling:** Tailwind CSS utility classes
- **HTTP Client:** Native `fetch` API wrapped in api-client.ts

**React Query Mutation Pattern** [Source: docs/architecture/frontend/06-api-integration.md]
- **Mutation Hook Structure:**
  ```typescript
  const mutation = useMutation({
    mutationFn: (data: CreateData) => apiClient.post('/endpoint', data),
    onSuccess: (data) => {
      // Invalidate queries to refetch data
      queryClient.invalidateQueries({ queryKey: ['resource'] });
      // Show success notification
      toast({ title: 'Success', description: 'Operation completed' });
    },
    onError: (error) => {
      // Handle error
      toast({ title: 'Error', description: error.message, variant: 'destructive' });
    },
  });
  ```
- **Usage in Components:**
  ```typescript
  const { mutate, isPending, isSuccess, isError } = useMutation(...);
  
  const handleSubmit = () => {
    mutate(formData);
  };
  ```
- **Cache Invalidation:** After mutation success, invalidate related queries to trigger refetch

**Next.js Dynamic Routes** [Source: Next.js docs, docs/architecture/frontend/07-routing.md]
- **Pattern:** `/app/[param]/page.tsx` creates dynamic route at `/[param]`
- **Access Params:** Use `useParams()` hook from `next/navigation`
  ```typescript
  import { useParams } from 'next/navigation';
  const params = useParams();
  const id = params.id as string;
  ```
- **File Structure for Job Detail:**
  ```
  frontend/app/jobs/
    [id]/
      page.tsx          <- Job detail page (dynamic route)
    page.tsx            <- Job list page
    layout.tsx          <- Shared layout
  ```

**Authentication Integration** [Source: Story 3.8, docs/architecture/coding-standards.md]
- **Auth Store (Zustand):**
  - Location: `frontend/src/features/auth/store/authStore.ts`
  - State: `{ user: User | null, token: string | null }`
  - Actions: `setAuth(user, token)`, `clearAuth()`, `isAuthenticated()`
  - Persistence: Uses Zustand persist middleware, syncs with localStorage
- **Token in API Requests:**
  ```typescript
  const token = localStorage.getItem('auth_token');
  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  };
  ```
- **Protected Actions Pattern:**
  ```typescript
  const isAuthenticated = useAuthStore((state) => state.isAuthenticated());
  
  if (!isAuthenticated) {
    router.push('/login');
    return;
  }
  
  // Proceed with authenticated action
  mutate(data);
  ```

**Component Standards** [Source: docs/architecture/frontend/04-component-standards.md]
- **File Naming:** page.tsx for routes (Next.js convention)
- **Client Components:** Require `"use client"` directive when using hooks/state
- **Props:** Explicit TypeScript interfaces, no implicit any
- **Exports:** Default export for pages, named exports for components

**Styling Guidelines** [Source: docs/architecture/frontend/08-styling-guidelines.md]
- **Utility-First:** Tailwind CSS classes directly in JSX
- **Component Variants:** Use `cn()` utility to merge class names
- **Responsive:** Mobile-first breakpoints (sm:, md:, lg:, xl:)
- **Spacing:** Consistent spacing using Tailwind scale (space-y-4, gap-2, p-6)

### File Locations and Structure

[Source: docs/architecture/frontend/03-project-structure.md, Story 3.7/3.8]

**Files to Create:**
- `frontend/app/jobs/[id]/page.tsx` - Job detail page (dynamic route)
- `frontend/hooks/use-job-posting.ts` - Custom hook for single job fetch
- `frontend/hooks/use-apply-to-job.ts` - Custom hook for application mutation

**Files to Update:**
- `frontend/lib/api-client.ts` - Add getJobPostingById and createApplication functions
- `frontend/app/jobs/page.tsx` - (Optional) Add Apply button to job cards

**Files Already Exist (No Changes):**
- `frontend/hooks/use-applications.ts` - Applications list hook (from Story 3.8)
- `frontend/hooks/use-job-postings.ts` - Job postings list hook (from Story 3.7)
- `frontend/src/features/auth/store/authStore.ts` - Auth store (from Story 1.3)
- `frontend/components/ui/*` - shadcn/ui components

**Files Referenced (Read-Only):**
- `frontend/components/ui/card.tsx` - Card component
- `frontend/components/ui/button.tsx` - Button component
- `frontend/components/ui/badge.tsx` - Badge component
- `frontend/components/ui/skeleton.tsx` - Skeleton component
- `frontend/components/ui/toast.tsx` - Toast component (may need installation)
- `frontend/lib/utils.ts` - cn() utility function

### TypeScript Type Definitions

**JobPosting Interface** (already defined in api-client.ts):
```typescript
export interface JobPosting {
  id: string;
  title: string;
  company: string;
  description: string;
  role_category: string;
  tech_stack: string | null;
  employment_type: string;
  work_setup: string;
  experience_level: string;
  location: string;
  salary_range_min: number | null;
  salary_range_max: number | null;
  required_skills: string[] | null;
  preferred_skills: string[] | null;
  benefits: string[] | null;
  posted_at: string;
  closing_at: string | null;
  status: string;
}
```

**ApplicationWithJobDetails Interface** (already defined in api-client.ts from Story 3.8):
```typescript
export interface ApplicationWithJobDetails {
  id: string;
  job_posting_id: string;
  candidate_id: string;
  status: ApplicationStatus;
  applied_at: string;
  interview_id: string | null;
  created_at: string;
  updated_at: string;
  job_posting: JobPosting;
  interview?: {
    id: string;
    status: string;
    role_type: string;
  };
}
```

**API Function Signatures:**
```typescript
// Add to api-client.ts
export async function getJobPostingById(id: string): Promise<JobPosting>;

export async function createApplication(jobPostingId: string): Promise<ApplicationWithJobDetails>;
```

**Custom Hook Return Types:**
```typescript
// use-job-posting.ts
export function useJobPosting(id: string): UseQueryResult<JobPosting, Error>;

// use-apply-to-job.ts
export function useApplyToJob(): UseMutationResult<
  ApplicationWithJobDetails,
  Error,
  string,
  unknown
>;
```

### Known Edge Cases and Constraints

1. **Already Applied State Persistence:**
   - After applying, the button must remain "Applied" even after page refresh
   - Solution: Query applications list and check if job_posting_id matches
   - Use React Query cache to avoid unnecessary API calls

2. **Duplicate Application Prevention:**
   - Backend returns 409 Conflict if candidate already applied
   - Frontend should prevent button click if already applied (button disabled)
   - Show appropriate error message if duplicate attempt made

3. **Authentication Token Expiration:**
   - JWT tokens expire after 24 hours (from Story 1.3)
   - 401 responses should clear auth and redirect to login
   - Return URL pattern: `/login?returnUrl=/jobs/${jobId}`

4. **Interview Link Availability:**
   - "Start Interview Now" link only shown after successful application
   - Link navigates to `/interview/start?application_id={id}`
   - Interview start page (Story 3.10) will handle application_id param

5. **Job Posting Not Found:**
   - If job ID invalid or job deleted, API returns 404
   - Show error message: "Job posting not found or no longer available"
   - Provide "Back to Jobs" button

6. **Network Failures:**
   - Show retry button on error
   - Preserve form state (job detail remains visible)
   - Don't redirect away from page on error

### Integration Verification Checklist

**IV1: Authentication Check** - Verify unauthenticated users see "Sign in to apply" instead of Apply button
- [ ] Logout → navigate to job detail → verify button text is "Sign in to apply"
- [ ] Click button → verify redirects to /login
- [ ] Login → verify redirects back to job detail page

**IV2: Application Submission** - Confirm application is created and linked to candidate correctly
- [ ] Submit application → verify API returns 201 Created
- [ ] Verify ApplicationWithJobDetails response includes interview_id
- [ ] Check backend database: application record exists with correct candidate_id and job_posting_id
- [ ] Check backend database: interview record exists and linked to application

**IV3: Navigation Consistency** - Verify browser back button works correctly after application submission
- [ ] Apply to job → success state shows
- [ ] Click browser back button → verify returns to /jobs page
- [ ] Click forward → verify job detail page still shows "Applied" button
- [ ] Navigate to /applications → verify new application in list

**IV4: Cache Invalidation** - Verify applications list updates after submission
- [ ] Navigate to /applications page → note current application count
- [ ] Navigate to /jobs → apply to new job → success
- [ ] Navigate back to /applications → verify new application appears in list (cache invalidated)
- [ ] Verify no duplicate entries or stale data

## Testing

### Manual Testing Checklist

**Test Environment Setup:**
1. Ensure backend running: `cd backend && uvicorn main:app --reload`
2. Ensure seed data exists: Run seed script if needed
3. Start frontend dev server: `cd frontend && pnpm dev`
4. Create test candidate account or use existing credentials

**Test Cases:**

**TC1: Job Detail Page Load**
- [ ] Navigate to http://localhost:3000/jobs
- [ ] Click "View Details" on any job card
- [ ] Verify skeleton loaders appear during fetch
- [ ] Verify job detail page loads with:
  - [ ] Job title and company
  - [ ] Full description
  - [ ] Required skills (badges)
  - [ ] Preferred skills (badges)
  - [ ] Benefits list
  - [ ] Location, salary, employment type, work setup, experience level
  - [ ] Back button to /jobs
  - [ ] Apply button at bottom

**TC2: Unauthenticated User Flow**
- [ ] Logout if logged in (clear localStorage)
- [ ] Navigate to job detail page
- [ ] Verify "Sign in to apply" button displays
- [ ] Click button
- [ ] Verify redirects to /login
- [ ] Enter valid credentials and login
- [ ] Verify redirects back to job detail page
- [ ] Verify "Apply Now" button now shows (not "Sign in to apply")

**TC3: Application Submission Flow**
- [ ] Ensure authenticated
- [ ] On job detail page, verify "Apply Now" button enabled
- [ ] Click "Apply Now" button
- [ ] Verify button changes to "Applying..." with spinner
- [ ] Verify button disabled during submission
- [ ] Wait for API response (should take <2 seconds)
- [ ] Verify success toast notification appears: "Application submitted successfully!"
- [ ] Verify button changes to "Applied" (success color, disabled)
- [ ] Verify "Start Interview Now" button/link appears
- [ ] Verify no console errors

**TC4: Already Applied State**
- [ ] After successful application (TC3), refresh the page
- [ ] Verify skeleton loaders appear during fetch
- [ ] Verify button shows "Applied" (disabled) after load
- [ ] Verify "Start Interview Now" link still visible
- [ ] Navigate away (to /jobs) and back to same job detail
- [ ] Verify button still shows "Applied" (persists)

**TC5: Duplicate Application Prevention**
- [ ] After applying to job (TC3), try to apply again
- [ ] Verify button is disabled (should not be clickable)
- [ ] (Optional) Manually call API via browser DevTools console:
   ```javascript
   fetch('http://localhost:8000/api/v1/applications', {
     method: 'POST',
     headers: {
       'Content-Type': 'application/json',
       'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
     },
     body: JSON.stringify({ job_posting_id: '{job-id}' })
   }).then(r => r.json()).then(console.log)
   ```
- [ ] Verify API returns 409 Conflict error
- [ ] Verify error message shows in UI (if error handling displays it)

**TC6: Error Handling - Network Failure**
- [ ] Stop backend server
- [ ] Navigate to new job detail page (one not yet applied to)
- [ ] Click "Apply Now" button
- [ ] Verify error toast/message appears
- [ ] Verify button returns to "Apply Now" state (not stuck in loading)
- [ ] Restart backend server
- [ ] Click "Apply Now" again (retry)
- [ ] Verify application succeeds this time

**TC7: Error Handling - Job Not Found**
- [ ] Navigate to invalid job ID: http://localhost:3000/jobs/99999999-9999-9999-9999-999999999999
- [ ] Verify error message displays: "Job posting not found"
- [ ] Verify "Back to Jobs" button present
- [ ] Click button → verify navigates to /jobs

**TC8: Interview Link Navigation**
- [ ] After successful application, click "Start Interview Now" button/link
- [ ] Verify navigation to `/interview/start?application_id={application-id}`
- [ ] Open browser DevTools → Console tab
- [ ] Add temporary console.log in interview start page to log application_id
- [ ] Verify application_id appears in console (confirms param passed correctly)
- [ ] Note: Interview start page full implementation is Story 3.10, just verify navigation works

**TC9: Applications List Update**
- [ ] Navigate to /applications page
- [ ] Note current number of applications
- [ ] Navigate to /jobs → select job not yet applied to
- [ ] Apply to that job → success
- [ ] Navigate back to /applications page
- [ ] Verify new application appears in list (cache invalidated)
- [ ] Verify application count increased by 1
- [ ] Verify no duplicate applications

**TC10: Responsive Design**
- [ ] Resize browser to 375px width (mobile)
- [ ] Navigate to job detail page
- [ ] Verify layout stacks vertically on mobile
- [ ] Verify all information readable (no horizontal scroll)
- [ ] Verify Apply button remains accessible at bottom
- [ ] Verify skills badges wrap correctly
- [ ] Resize back to desktop (1920px) → verify layout expands correctly

**TC11: Visual Consistency**
- [ ] Compare job detail page styling with job list cards
- [ ] Verify badge styles match (colors, sizes, padding)
- [ ] Verify button styles consistent with other pages
- [ ] Verify spacing and typography follow design system
- [ ] Verify card layouts use same shadows and borders

**TC12: React Query DevTools Verification**
- [ ] Open React Query DevTools (bottom left corner)
- [ ] Navigate to job detail page
- [ ] Verify query appears: `['job-postings', '{job-id}']`
- [ ] Verify query status: fetching → success
- [ ] Click "Apply Now" button
- [ ] Verify mutation executes in DevTools
- [ ] Verify mutation status: pending → success
- [ ] Verify `['applications', 'me']` query invalidates (status changes to stale)
- [ ] Navigate to /applications → verify cache hit or refetch

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (2024-10-22)

### Debug Log References
None - implementation proceeded smoothly without significant issues.

### Completion Notes List
1. **API Endpoint Verification**: Confirmed `GET /api/v1/job-postings/{id}` and `POST /api/v1/applications` endpoints exist and match expected schemas from Story 3.4 and 3.5.

2. **API Client Enhancement**: Added `createApplication()` function to `frontend/lib/api-client.ts` with comprehensive error handling for 409 (duplicate), 404 (not found), 400 (inactive), and 401 (auth) responses.

3. **Custom Hooks Created**:
   - `useJobPosting(id)`: React Query hook for fetching single job posting with caching and error handling
   - `useApplyToJob()`: React Query mutation hook for application submission with toast notifications and cache invalidation

4. **Job Detail Page**: Created dynamic route `/jobs/[id]` with comprehensive features:
   - Loading skeletons during data fetch
   - Error states with user-friendly messages
   - Full job details display (description, skills, benefits, salary, etc.)
   - Authentication-aware apply button (shows "Sign in to apply" for guests)
   - Already-applied detection (button shows "Applied" and is disabled)
   - Success state with "Start Interview Now" link
   - Responsive design for mobile/desktop

5. **Toast Integration**: Added `<Toaster />` component to `frontend/app/providers.tsx` for toast notifications on application success/error.

6. **Type Safety**: All code follows TypeScript strict mode with no `any` types. Build successful with Next.js 16.0.1.

7. **Testing Readiness**: Backend and frontend servers running successfully. API endpoints verified working with test data.

### File List
**Created:**
- `frontend/hooks/use-job-posting.ts` - React Query hook for fetching single job posting
- `frontend/hooks/use-apply-to-job.ts` - React Query mutation hook for application submission
- `frontend/app/jobs/[id]/page.tsx` - Job detail page with application submission

**Modified:**
- `frontend/lib/api-client.ts` - Added `createApplication()` function with error handling
- `frontend/app/providers.tsx` - Added `<Toaster />` component for toast notifications

**Note**: Task 6 (Apply button on job list cards) is marked as optional enhancement and was not implemented. Task 8 (Edge case testing) and Task 10 (Manual testing) require manual browser testing which is in progress.

### Status
Implementation Complete - Ready for Manual Testing

## QA Results
_To be filled by QA agent after implementation review and testing_

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story draft created for frontend application submission flow | SM Agent (Bob) |

---

**Epic:** Epic 03: Job-Driven AI Interview Flow (PRD: docs/prds/08-job-driven-interview-flow.md)  
**Dependencies:** Story 3.5 (Application REST API Endpoints - COMPLETED ✅), Story 3.7 (Frontend Job Browsing Page Update - COMPLETED ✅), Story 3.8 (Frontend Dashboard & Applications Page Update - COMPLETED ✅)  
**Blocks:** Story 3.10 (Frontend Interview Start with Job Context)

---
